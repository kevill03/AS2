<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subir Archivo - Cliente</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
</head>
<body class="d-flex flex-column min-vh-100">
  <div class="container mt-5 flex-grow-1">
    <h2 class="mb-4 text-center fw-bold">Gestor de Imágenes en la Nube</h2>

    <div class="card p-4 shadow-lg">
      <div class="mb-3">
        <label for="archivo" class="form-label">Selecciona un archivo</label>
        <input class="form-control" type="file" id="archivo" required />
      </div>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary flex-fill" id="submitBtn">Subir Imagen</button>
        <button type="button" class="btn btn-secondary flex-fill" id="listarBtn">Listar Imágenes</button>
      </div>

      <div id="resultado" class="mt-4 text-center"></div>
      <div id="tablaArchivos" class="mt-5 text-dark"></div>
    </div>
  </div>

  <footer class="footer text-center text-white">
    <div class="py-3">
      Kevin Medina AS2
    </div>
  </footer>

  <script>
    const submitBtn = document.getElementById('submitBtn');
    const listarBtn = document.getElementById('listarBtn');
    const archivoInput = document.getElementById('archivo');
    const resultadoDiv = document.getElementById('resultado');
    const tablaArchivosDiv = document.getElementById('tablaArchivos');

    const BACKEND_URL = 'https://as2-production-2ddf.up.railway.app';

    submitBtn.addEventListener('click', async () => {
      const archivo = archivoInput.files[0];

      if (!archivo) {
        Swal.fire('⚠️', 'Por favor selecciona un archivo antes de subir.', 'warning');
        return;
      }

      const formData = new FormData();
      formData.append('archivo', archivo);

      try {
        const response = await fetch(`${BACKEND_URL}/upload`, {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) throw new Error('Respuesta del servidor no OK');

        const data = await response.json();

        await Swal.fire({
          icon: 'success',
          title: 'Archivo subido correctamente',
          text: 'Redirigiendo...',
          timer: 1500,
          showConfirmButton: false
        });

        window.location.href = `exito.html?url=${encodeURIComponent(data.url)}`;
      } catch (error) {
        console.error('❌ Error al subir:', error);
        await Swal.fire({
          icon: 'error',
          title: 'Error al subir el archivo',
          text: 'Por favor, Recuerda que solo puedes gestionar imagenes en nuestro sistema, verifica el tipo de archivo e intenta de nuevo.',
          showConfirmButton: true
        });
      }
    });

    listarBtn.addEventListener('click', listarArchivos);

    async function listarArchivos() {
      try {
        const response = await fetch(`${BACKEND_URL}/archivos`);
        const archivos = await response.json();

        if (!Array.isArray(archivos)) throw new Error('Respuesta inesperada');

        let tablaHTML = `
          <table class="table table-striped table-bordered table-hover bg-white text-dark">
            <thead>
              <tr>
                <th>#</th>
                <th>URL</th>
                <th>Public ID</th>
                <th>Fecha de subida</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
        `;

        archivos.forEach((archivo, index) => {
          tablaHTML += `
            <tr>
              <td>${index + 1}</td>
              <td><a href="${archivo.url}" target="_blank">Ver archivo</a></td>
              <td>${archivo.public_id}</td>
              <td>${new Date(archivo.fecha_subida).toLocaleString()}</td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarArchivo('${archivo.public_id}')">
                  Eliminar
                </button>
              </td>
            </tr>
          `;
        });

        tablaHTML += `</tbody></table>`;
        tablaArchivosDiv.innerHTML = tablaHTML;
      } catch (error) {
        console.error('❌ Error al listar:', error);
        tablaArchivosDiv.innerHTML = `<div class="alert alert-danger">Error al obtener archivos.</div>`;
      }
    }

    async function eliminarArchivo(publicId) {
      const { isConfirmed } = await Swal.fire({
        title: `¿Eliminar archivo?`,
        text: `ID: ${publicId}`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      });

      if (!isConfirmed) return;

      try {
        const response = await fetch(`${BACKEND_URL}/delete/${encodeURIComponent(publicId)}`, {
          method: 'DELETE',
        });

        if (!response.ok) throw new Error('No se pudo eliminar');

        await Swal.fire('Eliminado', 'El archivo fue eliminado correctamente.', 'success');
        listarArchivos();
      } catch (error) {
        console.error('❌ Error al eliminar:', error);
        await Swal.fire('Error', 'Ocurrió un error al intentar eliminar el archivo.', 'error');
      }
    }
  </script>
</body>
</html>








